<form [formGroup]="scenarioForm" data-test-id="scenario-form">
  <app-stepper [stepperConfig]="stepperConfig()" (cancelClicked)="onCancel()" (finishClicked)="onSubmit()" (stepChanged)="onStepChanged($event)" data-test-id="scenario-stepper">
    <cdk-step data-test-id="product-step">
      <div class="rounded-lg lg:max-w-5xl w-full mx-auto lg:py-8 py-16" formGroupName="product">
        <div class="mb-6">
          <label for="title" class="flex justify-between items-center text-sm font-medium text-[#5B616C] mb-2">
            Title
            <img src="images/title-icon.svg" alt="title info icon" />
          </label>
          <div class="flex border border-gray-300 rounded-md shadow-sm bg-white pr-2">
            <input
            id="title"
            type="text"
            formControlName="title"
            data-test-id="product-title-input"
            [class]="productGroup.controls['title'].invalid && productGroup.controls['title'].touched
              ? 'w-full px-4 py-2 border border-[#FF4530] focus:outline-none focus:ring-0 rounded-md'
              : 'w-full px-4 py-2 outline-none rounded-md placeholder:text-[#9297A0] text-lg'"
            [attr.aria-invalid]="productGroup.controls['title'].invalid && productGroup.controls['title'].touched ? 'true' : 'false'"
            [attr.aria-describedby]="productGroup.controls['title'].invalid && productGroup.controls['title'].touched ? 'title-error' : null"
            placeholder="Scenario title" />
            <img src="images/globe-icon.svg" alt="scenario title globe icon" />
          </div>
          
          @if (productGroup.controls['title'].invalid && productGroup.controls['title'].touched) {
            <div id="title-error" class="mt-1 text-sm text-red-600" data-test-id="product-title-error" role="alert" aria-live="polite">Title is required</div>
          }
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div>
            <label for="tenant" class="block text-sm font-medium text-[#747884] mb-2">Select Tenant</label>
            <select
              id="tenant"
              formControlName="tenant"
              data-test-id="product-tenant-select"
              [class]="productGroup.controls['tenant'].invalid && productGroup.controls['tenant'].touched
                ? 'w-full px-3 py-2 border border-[#FF4530] rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-gray-900 text-lg'
                : 'w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-gray-900 text-lg'"
              [attr.aria-invalid]="productGroup.controls['tenant'].invalid && productGroup.controls['tenant'].touched ? 'true' : 'false'"
              [attr.aria-describedby]="productGroup.controls['tenant'].invalid && productGroup.controls['tenant'].touched ? 'tenant-error' : null">
              <option value="">Choose a tenant...</option>
              @for (tenant of tenantOptions; track tenant.id) {
                <option [value]="tenant.id">{{ tenant.name }}</option>
              }
            </select>
            @if (productGroup.controls['tenant'].invalid && productGroup.controls['tenant'].touched) {
              <div id="tenant-error" class="mt-1 text-sm text-red-600" data-test-id="product-tenant-error" role="alert" aria-live="polite">Please select a tenant</div>
            }
          </div>

          <div>
            <label for="company" class="block text-sm font-medium text-[#747884] mb-2">Select Company</label>
            <select
              id="company"
              formControlName="company"
              data-test-id="product-company-select"
              [class]="productGroup.controls['company'].invalid && productGroup.controls['company'].touched
                ? 'w-full px-3 py-2 border border-[#FF4530] rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-gray-900 text-lg'
                : 'w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-gray-900 text-lg'"
              [attr.aria-invalid]="productGroup.controls['company'].invalid && productGroup.controls['company'].touched ? 'true' : 'false'"
              [attr.aria-describedby]="productGroup.controls['company'].invalid && productGroup.controls['company'].touched ? 'company-error' : null">
              <option value="">Choose a company...</option>
              @for (company of companyOptions; track company.id) {
                <option [value]="company.id">{{ company.name }}</option>
              }
            </select>
            @if (productGroup.controls['company'].invalid && productGroup.controls['company'].touched) {
              <div id="company-error" class="mt-1 text-sm text-red-600" role="alert" aria-live="polite">Please select a company</div>
            }
          </div>
        </div>

        <div class="mb-8">
          <label for="experienceProduct" class="block text-sm font-medium text-[#747884] mb-2">Select Employee Experience Product</label>
          <div [class]="productGroup.controls['experienceProduct'].invalid && productGroup.controls['experienceProduct'].touched
            ? 'flex items-center justify-start border border-[#FF4530] rounded-md shadow-sm bg-white pl-4 pr-0'
            : 'flex items-center justify-start border border-gray-300 rounded-md shadow-sm bg-white pl-4 pr-0'">
            <img src="images/eep-icon.svg" alt="employee happiness label icon" class="h-6 mr-2" />
            <select
            id="experienceProduct"
            formControlName="experienceProduct"
            class="w-full py-2 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-gray-900 text-lg"
            [attr.aria-invalid]="productGroup.controls['experienceProduct'].invalid && productGroup.controls['experienceProduct'].touched ? 'true' : 'false'"
            [attr.aria-describedby]="productGroup.controls['experienceProduct'].invalid && productGroup.controls['experienceProduct'].touched ? 'experience-product-error' : null">
            <option value="">Choose a product...</option>
            @for (product of experienceProductOptions; track product.id) {
              <option [value]="product.id">{{ product.name }}</option>
            }
          </select>
          </div>
          @if (productGroup.controls['experienceProduct'].invalid && productGroup.controls['experienceProduct'].touched) {
            <div id="experience-product-error" class="mt-1 text-sm text-red-600" role="alert" aria-live="polite">Please select an employee experience product</div>
          }
        </div>

        <div class="flex items-center justify-between mb-4 bg-[#F1F2F3] px-4 py-3">
          <h3 class="text-[9.9px] font-semibold text-[#747884] uppercase">SURVEYS LIST</h3>
        </div>

        <div class="bg-white rounded-lg border border-gray-200 overflow-y-scroll">
          <table class="w-full" role="table" aria-label="Survey selection table">
            <thead class="bg-gray-50 border-b border-gray-200">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">
                  <input
                    type="checkbox"
                    [checked]="areAllCurrentPageSurveysSelected()"
                    [indeterminate]="areSomeCurrentPageSurveysSelected()"
                    (change)="toggleAllCurrentPageSurveys()"
                    class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary"
                    aria-label="Select all surveys on current page">
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NAME</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CREATION DATE</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">START DATE</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">END DATE</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              @for (survey of currentPageSurveys(); track survey.id) {
                <tr class="hover:bg-gray-50 transition-colors">
                  <td class="px-6 py-4 whitespace-nowrap">
                    <input
                      type="checkbox"
                      [checked]="survey.selected"
                      (change)="toggleSurvey(survey.id)"
                      class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary"
                      [attr.aria-label]="'Select survey: ' + survey.name">
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">{{ survey.name }}</div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-500">{{ survey.creationDate }}</div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-500">{{ survey.startDate }}</div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-500">{{ survey.endDate }}</div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <div class="flex flex-col lg:flex-row gap-2 items-center justify-between mt-6">
          <div class="text-sm text-gray-700" id="pagination-info" aria-live="polite">
            Showing {{ currentPageStartIndex() }} - {{ currentPageEndIndex() }} of {{ pagination().totalSurveys }} surveys
          </div>
          <nav aria-label="Survey pagination" class="flex gap-1">
            @for (page of paginationPages(); track page) {
              <button
                type="button"
                (click)="goToPage(page)"
                [class]="page === pagination().currentPage
                  ? 'bg-primary text-white'
                  : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'"
                class="px-3 py-2 text-sm font-medium rounded transition-colors focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
                [attr.aria-label]="page === pagination().currentPage ? 'Current page, page ' + page : 'Go to page ' + page"
                [attr.aria-current]="page === pagination().currentPage ? 'page' : null">
                {{ page }}
              </button>
            }
          </nav>
          <div class="flex items-center space-x-2">
            <span class="text-sm text-gray-500 mr-3" aria-describedby="pagination-info">Page {{ pagination().currentPage }} of {{ pagination().totalPages }}</span>
          </div>
        </div>
      </div>
    </cdk-step>

    <cdk-step>
      <div class="rounded-lg lg:max-w-5xl w-full mx-auto lg:py-8 py-16">
        <h3 class="text-lg font-medium text-[#282D39]">Set the Total Number of Respondents</h3>
        <p class="text-[#747884] text-xs mt-3">Define the total number of respondents for this scenario. This number determines the sample size for data collection and scoring distribution.</p>

        <div class="my-6">
          <label for="respondentsTotal" class="flex justify-between items-center text-sm font-medium text-[#5B616C] mb-2">
            Total Respondents
          </label>
          <div class="flex border border-gray-300 rounded-md shadow-sm bg-white pr-2">
            <input
            id="respondentsTotal"
            type="number"
            min="0"
            formControlName="respondentsTotal"
            [class]="respondentsTotal.invalid && respondentsTotal.touched
              ? 'w-full px-4 py-2 border border-[#FF4530] focus:outline-none focus:ring-0 rounded-md'
              : 'w-full px-4 py-2 outline-none rounded-md placeholder:text-[#9297A0] text-lg'"
            [attr.aria-invalid]="respondentsTotal.invalid && respondentsTotal.touched ? 'true' : 'false'"
            [attr.aria-describedby]="respondentsTotal.invalid && respondentsTotal.touched ? 'respondents-total-error' : null"
            placeholder="Number of respondents" />
            <img src="images/globe-icon.svg" alt="scenario title globe icon" />
          </div>

          @if (respondentsTotal.invalid && respondentsTotal.touched) {
            <div id="respondents-total-error" class="mt-1 text-sm text-red-600" role="alert" aria-live="polite">Total number of respondents is required</div>
          }
        </div>
      </div>
    </cdk-step>

    <cdk-step>
      <div class="rounded-lg lg:max-w-5xl w-full mx-auto lg:py-8 py-16">
        <h3 class="text-lg font-medium text-[#282D39]">Select Criteria for Distribution</h3>
        <p class="text-[#747884] text-xs mt-3">Choose the criteria that will be used for score distribution. You can apply a High (H) or Low (L) distribution mode to each selected criterion</p>

        <div class="grid grid-cols-1 lg:grid-cols-[30%_1fr] gap-8 mt-8">
          <div>
            <div class="flex items-center justify-between mb-4 bg-[#F1F2F3] px-4 py-3">
              <h4 class="text-[9.9px] font-semibold text-[#747884] uppercase">Selected Criteria</h4>
            </div>

            <div class="space-y-3">
              @for (criterion of availableCriteria; track criterion.type) {
                <label class="flex items-center space-x-3 cursor-pointer">
                  <input
                    type="checkbox"
                    [checked]="isCriterionSelected(criterion.type)"
                    (change)="toggleCriterion(criterion.type)"
                    class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary"
                  />
                  <span class="text-sm font-medium text-[#282D39]">{{ criterion.name }}</span>
                </label>
              }
            </div>
          </div>

          <div>
            <div class="flex items-center justify-start mb-4 gap-6 bg-[#F1F2F3] px-4 py-3">
              <h4 class="text-[9.9px] font-semibold text-[#747884] uppercase">Selected Criteria</h4>
              <span class="text-[9.9px] font-semibold text-[#747884] bg-[#d8d8db] rounded-full px-2 py-1">{{ selectedCriteriaTypes().length }}</span>
            </div>

            <div class="space-y-6">

              @for (criteriaType of selectedCriteriaTypes(); track criteriaType) {
                @let group = getCriteriaGroup(criteriaType);
                @if (group) {
                  <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-4">
                      <div class="flex items-center space-x-2">
                        <span class="w-6 h-6 border-2 border-primary text-primary rounded-md flex items-center justify-center text-xs font-medium">
                          {{ selectedCriteriaTypes().indexOf(criteriaType) + 1 }}
                        </span>
                        <h5 class="text-sm font-medium text-[#282D39]">{{ group.name }}</h5>
                      </div>
                      <button
                        type="button"
                        (click)="addDistributionItem(criteriaType, '', '')"
                        class="text-primary text-sm"
                        [attr.aria-label]="'Add new ' + group.name.toLowerCase() + ' criteria'"
                      >
                        + Add
                      </button>
                    </div>

                    @if (group.items.length === 0) {
                      <p class="mt-4 text-sm text-red-700">Please add distribution items for the selected criteria by clicking "+ Add" button.</p>
                    }

                    @if (hasDuplicatesInCriteriaType(criteriaType)) {
                      <p class="mt-4 text-sm text-red-700">You cannot add the same criteria value twice. Please remove duplicate entries.</p>
                    }

                    <div class="space-y-3">
                      @for (item of group.items; track item.criteriaId; let i = $index) {
                        <div>
                          <div class="flex items-center gap-4">
                            <button type="button" aria-label="Drag to reorder criteria item" tabindex="-1">
                              <img src="images/drag-handle.svg" alt="drag icon for criteria" />
                            </button>

                            <div class="flex-1">
                              <select
                                [value]="item.criteriaId"
                                (change)="updateDistributionItem(criteriaType, i, $event)"
                                (blur)="markDistributionValueAsTouched(criteriaType, i)"
                                [class]="getDistributionValueControlByIndex(criteriaType, i)?.invalid && getDistributionValueControlByIndex(criteriaType, i)?.touched
                                  ? 'w-full px-3 py-2 border border-[#FF4530] rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-sm text-[#9297A0]'
                                  : 'w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-sm text-[#9297A0]'"
                              >
                                <option value="">Choose {{ group.name.toLowerCase() }}...</option>
                                @for (option of criteriaOptions[criteriaType]; track option.id) {
                                  <option [value]="option.id">{{ option.name }}</option>
                                }
                              </select>
                              @if (getDistributionValueControlByIndex(criteriaType, i)?.invalid && getDistributionValueControlByIndex(criteriaType, i)?.touched) {
                                <div class="mt-1 text-xs text-red-600">Please select a {{ group.name.toLowerCase() }}</div>
                              }
                            </div>

                            <div class="flex items-center space-x-1">
                              <div>
                                <input
                                  type="number"
                                  [value]="item.percentage || ''"
                                  (input)="updateDistributionPercentageFromEventByIndex(criteriaType, i, $event)"
                                  min="1"
                                  max="100"
                                  [class]="getDistributionPercentageControlByIndex(criteriaType, i)?.invalid && getDistributionPercentageControlByIndex(criteriaType, i)?.touched
                                    ? 'w-16 px-2 py-2 border border-[#FF4530] rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-sm text-[#9297A0] text-center'
                                    : 'w-16 px-2 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-sm text-[#9297A0] text-center'"
                                />
                                @if (getDistributionPercentageControlByIndex(criteriaType, i)?.invalid && getDistributionPercentageControlByIndex(criteriaType, i)?.touched) {
                                  <div class="mt-1 text-xs text-red-600">
                                    @if (getDistributionPercentageControlByIndex(criteriaType, i)?.hasError('required')) {
                                      Required
                                    }
                                    @if (getDistributionPercentageControlByIndex(criteriaType, i)?.hasError('min')) {
                                      Min is 0
                                    }
                                    @if (getDistributionPercentageControlByIndex(criteriaType, i)?.hasError('max')) {
                                      Max is 100
                                    }
                                  </div>
                                }
                              </div>
                              <span class="text-sm text-[#747884]">%</span>
                            </div>

                            <button
                              type="button"
                              (click)="removeDistributionItem(criteriaType, i)"
                              class="w-6 h-6 flex justify-center items-center bg-[#FF45301A] rounded-sm"
                              [attr.aria-label]="'Remove ' + group.name.toLowerCase() + ' criteria'"
                            >
                              <img src="images/red-trash-icon.svg" alt="red trash icon for criteria control delete" />
                            </button>
                          </div>
                        </div>
                      }
                    </div>

                    @if (group.items.length > 0) {
                      <div class="mt-4 pt-3 border-t border-gray-200">
                        <div class="flex items-center justify-between">
                          <span class="text-[9.9px] font-medium text-[#747884] uppercase">TOTAL DISTRIBUTION</span>
                          <span
                            class="text-sm font-medium px-2 py-1 rounded bg-[#0082C61A] text-primary"
                          >
                            {{ group.totalPercentage }}%
                          </span>
                        </div>
                      </div>
                    }
                  </div>
                }
              }

              @if (selectedCriteriaTypes().length === 0) {
                <div class="text-center py-8">
                  <p class="text-[#747884] text-sm">Select criteria from the left panel to start configuring distributions</p>
                </div>
              }
            </div>
          </div>
        </div>
      </div>
    </cdk-step>

    <cdk-step>
      <fieldset class="rounded-lg lg:max-w-5xl w-full mx-auto lg:py-8 py-16" formGroupName="impactDrivers">
        <legend class="text-lg font-medium text-[#282D39]">Set the impact drivers</legend>
        <p class="text-[#747884] text-xs mt-3">Distribute the weightage (in percentages) for different factors. The total should sum up to 100%. The system will calculate the Overall Score dynamically based on the provided values</p>

        <div class="mt-8 space-y-2" aria-labelledby="impact-drivers-heading">
          <div id="impact-drivers-heading" class="grid grid-cols-[1fr_20%] gap-2 px-4 py-2">
            <p class="font-semibold text-xs uppercase text-[#747884]">Drivers</p>
            <div class="text-center">
              <p class="font-semibold text-xs uppercase text-[#747884]">AVG.</p>
            </div>
          </div>
          <div class="grid grid-cols-[1fr_20%] bg-[#F1F2F3] gap-2 px-4 py-2">
            <div class="flex justify-start items-center gap-2">
              <p class="text-white font-bold text-2xl text-center bg-primary rounded-md px-4 py-1 w-12">I</p>
              <p class="text-[#747884] font-medium text-sm uppercase">Innovation</p>
            </div>
            <div class="flex flex-col space-x-1">
              <div class="flex items-center">
                <input
                  type="number"
                  min="0"
                  max="100"
                  formControlName="innovation"
                  [class]="impactDriversGroup.controls['innovation'].invalid && impactDriversGroup.controls['innovation'].touched
                    ? 'w-full px-2 py-2 border border-[#FF4530] rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-sm text-[#9297A0] text-center'
                    : 'w-full px-2 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-sm text-[#9297A0] text-center'"
                  [attr.aria-invalid]="impactDriversGroup.controls['innovation'].invalid && impactDriversGroup.controls['innovation'].touched ? 'true' : 'false'"
                  [attr.aria-describedby]="impactDriversGroup.controls['innovation'].invalid && impactDriversGroup.controls['innovation'].touched ? 'innovation-error' : null"
                  aria-label="Innovation percentage (0-100)"
                  placeholder="0"
                />
                <span class="text-sm text-[#747884]">%</span>
              </div>
              @if (impactDriversGroup.controls['innovation'].invalid && impactDriversGroup.controls['innovation'].touched) {
              <div id="innovation-error" class="mt-1 text-xs text-red-600" role="alert" aria-live="polite">
                @if (impactDriversGroup.controls['innovation'].hasError('max')) {
                  Value must be 100 or less
                }
                @if (impactDriversGroup.controls['innovation'].hasError('min')) {
                  Value must be 0 or greater
                }
              </div>
            }
            </div>
          </div>
          <div class="grid grid-cols-[1fr_20%] bg-[#F1F2F3] gap-2 px-4 py-2">
            <div class="flex justify-start items-center gap-2">
              <p class="text-white font-bold text-2xl text-center bg-primary rounded-md px-4 py-1 w-12">M</p>
              <p class="text-[#747884] font-medium text-sm uppercase">Motivation</p>
            </div>
            <div class="flex flex-col space-x-1">
              <div class="flex items-center">
                <input
                  type="number"
                  min="0"
                  max="100"
                  formControlName="motivation"
                  [class]="impactDriversGroup.controls['motivation'].invalid && impactDriversGroup.controls['motivation'].touched
                    ? 'w-full px-2 py-2 border border-[#FF4530] rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-sm text-[#9297A0] text-center'
                    : 'w-full px-2 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-sm text-[#9297A0] text-center'"
                  [attr.aria-invalid]="impactDriversGroup.controls['motivation'].invalid && impactDriversGroup.controls['motivation'].touched ? 'true' : 'false'"
                  [attr.aria-describedby]="impactDriversGroup.controls['motivation'].invalid && impactDriversGroup.controls['motivation'].touched ? 'motivation-error' : null"
                  aria-label="Motivation percentage (0-100)"
                  placeholder="0"
                />
                <span class="text-sm text-[#747884]">%</span>
              </div>
              @if (impactDriversGroup.controls['motivation'].invalid && impactDriversGroup.controls['motivation'].touched) {
              <div id="motivation-error" class="mt-1 text-xs text-red-600" role="alert" aria-live="polite">
                @if (impactDriversGroup.controls['motivation'].hasError('max')) {
                  Value must be 100 or less
                }
                @if (impactDriversGroup.controls['motivation'].hasError('min')) {
                  Value must be 0 or greater
                }
              </div>
            }
            </div>
          </div>
          <div class="grid grid-cols-[1fr_20%] bg-[#F1F2F3] gap-2 px-4 py-2">
            <div class="flex justify-start items-center gap-2">
              <p class="text-white font-bold text-2xl text-center bg-primary rounded-md px-4 py-1 w-12">P</p>
              <p class="text-[#747884] font-medium text-sm uppercase">Performance</p>
            </div>
            <div class="flex flex-col space-x-1">
              <div class="flex items-center">
                <input
                  type="number"
                  min="0"
                  max="100"
                  formControlName="performance"
                  [class]="impactDriversGroup.controls['performance'].invalid && impactDriversGroup.controls['performance'].touched
                    ? 'w-full px-2 py-2 border border-[#FF4530] rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-sm text-[#9297A0] text-center'
                    : 'w-full px-2 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-sm text-[#9297A0] text-center'"
                  [attr.aria-invalid]="impactDriversGroup.controls['performance'].invalid && impactDriversGroup.controls['performance'].touched ? 'true' : 'false'"
                  [attr.aria-describedby]="impactDriversGroup.controls['performance'].invalid && impactDriversGroup.controls['performance'].touched ? 'performance-error' : null"
                  aria-label="Performance percentage (0-100)"
                  placeholder="0"
                />
                <span class="text-sm text-[#747884]">%</span>
              </div>
              @if (impactDriversGroup.controls['performance'].invalid && impactDriversGroup.controls['performance'].touched) {
              <div id="performance-error" class="mt-1 text-xs text-red-600" role="alert" aria-live="polite">
                @if (impactDriversGroup.controls['performance'].hasError('max')) {
                  Value must be 100 or less
                }
                @if (impactDriversGroup.controls['performance'].hasError('min')) {
                  Value must be 0 or greater
                }
              </div>
            }
            </div>
          </div>
          <div class="grid grid-cols-[1fr_20%] bg-[#F1F2F3] gap-2 px-4 py-2">
            <div class="flex justify-start items-center gap-2">
              <p class="text-white font-bold text-2xl text-center bg-primary rounded-md px-4 py-1 w-12">A</p>
              <p class="text-[#747884] font-medium text-sm uppercase">Autonomy</p>
            </div>
            <div class="flex flex-col space-x-1">
              <div class="flex items-center">
                <input
                  type="number"
                  min="0"
                  max="100"
                  formControlName="autonomy"
                  [class]="impactDriversGroup.controls['autonomy'].invalid && impactDriversGroup.controls['autonomy'].touched
                    ? 'w-full px-2 py-2 border border-[#FF4530] rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-sm text-[#9297A0] text-center'
                    : 'w-full px-2 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-sm text-[#9297A0] text-center'"
                  [attr.aria-invalid]="impactDriversGroup.controls['autonomy'].invalid && impactDriversGroup.controls['autonomy'].touched ? 'true' : 'false'"
                  [attr.aria-describedby]="impactDriversGroup.controls['autonomy'].invalid && impactDriversGroup.controls['autonomy'].touched ? 'autonomy-error' : null"
                  aria-label="Autonomy percentage (0-100)"
                  placeholder="0"
                />
                <span class="text-sm text-[#747884]">%</span>
              </div>
              @if (impactDriversGroup.controls['autonomy'].invalid && impactDriversGroup.controls['autonomy'].touched) {
              <div id="autonomy-error" class="mt-1 text-xs text-red-600" role="alert" aria-live="polite">
                @if (impactDriversGroup.controls['autonomy'].hasError('max')) {
                  Value must be 100 or less
                }
                @if (impactDriversGroup.controls['autonomy'].hasError('min')) {
                  Value must be 0 or greater
                }
              </div>
            }
            </div>
          </div>
          <div class="grid grid-cols-[1fr_20%] bg-[#F1F2F3] gap-2 px-4 py-2">
            <div class="flex justify-start items-center gap-2">
              <p class="text-white font-bold text-2xl text-center bg-primary rounded-md px-4 py-1 w-12">C</p>
              <p class="text-[#747884] font-medium text-sm uppercase">Connection</p>
            </div>
            <div class="flex flex-col space-x-1">
              <div class="flex items-center">
                <input
                  type="number"
                  min="0"
                  max="100"
                  formControlName="connection"
                  [class]="impactDriversGroup.controls['connection'].invalid && impactDriversGroup.controls['connection'].touched
                    ? 'w-full px-2 py-2 border border-[#FF4530] rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-sm text-[#9297A0] text-center'
                    : 'w-full px-2 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-sm text-[#9297A0] text-center'"
                  [attr.aria-invalid]="impactDriversGroup.controls['connection'].invalid && impactDriversGroup.controls['connection'].touched ? 'true' : 'false'"
                  [attr.aria-describedby]="impactDriversGroup.controls['connection'].invalid && impactDriversGroup.controls['connection'].touched ? 'connection-error' : null"
                  aria-label="Connection percentage (0-100)"
                  placeholder="0"
                />
                <span class="text-sm text-[#747884]">%</span>
              </div>
              @if (impactDriversGroup.controls['connection'].invalid && impactDriversGroup.controls['connection'].touched) {
              <div id="connection-error" class="mt-1 text-xs text-red-600" role="alert" aria-live="polite">
                @if (impactDriversGroup.controls['connection'].hasError('max')) {
                  Value must be 100 or less
                }
                @if (impactDriversGroup.controls['connection'].hasError('min')) {
                  Value must be 0 or greater
                }
              </div>
            }
            </div>
          </div>
          <div class="grid grid-cols-[1fr_20%] bg-[#F1F2F3] gap-2 px-4 py-2">
            <div class="flex justify-start items-center gap-2">
              <p class="text-white font-bold text-2xl text-center bg-primary rounded-md px-4 py-1 w-12">T</p>
              <p class="text-[#747884] font-medium text-sm uppercase">Transformational Leadership</p>
            </div>
            <div class="flex flex-col space-x-1">
              <div class="flex items-center">
                <input
                  type="number"
                  min="0"
                  max="100"
                  formControlName="transformationalLeadership"
                  [class]="impactDriversGroup.controls['transformationalLeadership'].invalid && impactDriversGroup.controls['transformationalLeadership'].touched
                    ? 'w-full px-2 py-2 border border-[#FF4530] rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-sm text-[#9297A0] text-center'
                    : 'w-full px-2 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-sm text-[#9297A0] text-center'"
                  [attr.aria-invalid]="impactDriversGroup.controls['transformationalLeadership'].invalid && impactDriversGroup.controls['transformationalLeadership'].touched ? 'true' : 'false'"
                  [attr.aria-describedby]="impactDriversGroup.controls['transformationalLeadership'].invalid && impactDriversGroup.controls['transformationalLeadership'].touched ? 'transformational-leadership-error' : null"
                  aria-label="Transformational Leadership percentage (0-100)"
                  placeholder="0"
                />
                <span class="text-sm text-[#747884]">%</span>
              </div>
              @if (impactDriversGroup.controls['transformationalLeadership'].invalid && impactDriversGroup.controls['transformationalLeadership'].touched) {
              <div id="transformational-leadership-error" class="mt-1 text-xs text-red-600" role="alert" aria-live="polite">
                @if (impactDriversGroup.controls['transformationalLeadership'].hasError('max')) {
                  Value must be 100 or less
                }
                @if (impactDriversGroup.controls['transformationalLeadership'].hasError('min')) {
                  Value must be 0 or greater
                }
              </div>
            }
            </div>
          </div>

          <div class="items-center justify-between px-4 py-2 grid grid-cols-[1fr_20%]">
            <span class="text-sm font-medium text-[#5B616C] uppercase">Overall Score</span>
            <span class="text-sm font-medium px-4 py-2 border border-[#E4E5E7] rounded-md bg-white text-[#5B616C] w-full text-center" aria-live="polite" aria-label="Overall impact drivers score">
              {{ impactDriversTotal() }}%
            </span>
          </div>
        </div>
      </fieldset>
    </cdk-step>

    <cdk-step>
      <fieldset class="rounded-lg lg:max-w-5xl w-full mx-auto lg:py-8 py-16" formGroupName="enpsSettings">
        <legend class="text-lg font-medium text-[#282D39]">Configure eNPS Settings</legend>

        <div id="enps-settings-heading" class="w-full flex justify-center items-center gap-2 my-8">
          <img src="images/meter-icon.svg" alt="meter icon for enps settings" />
          <p class="text-[#282D39] text-[40px] font-medium" aria-live="polite" aria-label="eNPS total percentage">{{ enpsSettingsTotal() }}%</p>
        </div>

        <div class="mt-8 space-y-2" aria-labelledby="enps-settings-heading">
          <div class="grid grid-cols-[1fr_20%] bg-[#F1F2F3] gap-2 px-4 py-2">
            <div class="flex justify-start items-center gap-2">
              <p class="bg-[#3fb75b] rounded-md px-4 py-1 w-8 h-8"></p>
              <p class="text-[#5B616C] font-medium text-sm uppercase">Promoters</p>
            </div>
            <div class="flex flex-col space-x-1">
              <div class="flex items-center">
                <input
                  type="number"
                  min="0"
                  max="100"
                  formControlName="promoters"
                  [class]="enpsSettingsGroup.controls['promoters'].invalid && enpsSettingsGroup.controls['promoters'].touched
                    ? 'w-full px-2 py-2 border border-[#FF4530] rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-sm text-[#9297A0] text-center'
                    : 'w-full px-2 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-sm text-[#9297A0] text-center'"
                  [attr.aria-invalid]="enpsSettingsGroup.controls['promoters'].invalid && enpsSettingsGroup.controls['promoters'].touched ? 'true' : 'false'"
                  [attr.aria-describedby]="enpsSettingsGroup.controls['promoters'].invalid && enpsSettingsGroup.controls['promoters'].touched ? 'promoters-error' : null"
                  aria-label="Promoters percentage (0-100)"
                  placeholder="0"
                />
                <span class="text-sm text-[#747884]">%</span>
              </div>
              @if (enpsSettingsGroup.controls['promoters'].invalid && enpsSettingsGroup.controls['promoters'].touched) {
              <div id="promoters-error" class="mt-1 text-xs text-red-600" role="alert" aria-live="polite">
                @if (enpsSettingsGroup.controls['promoters'].hasError('max')) {
                  Value must be 100 or less
                }
                @if (enpsSettingsGroup.controls['promoters'].hasError('min')) {
                  Value must be 0 or greater
                }
              </div>
            }
            </div>
          </div>
          <div class="grid grid-cols-[1fr_20%] bg-[#F1F2F3] gap-2 px-4 py-2">
            <div class="flex justify-start items-center gap-2">
              <p class="bg-[#ff9601] rounded-md px-4 py-1 w-8 h-8"></p>
              <p class="text-[#5B616C] font-medium text-sm uppercase">
                Passives
              </p>
            </div>
            <div class="flex flex-col space-x-1">
              <div class="flex items-center">
                <input
                  type="number"
                  min="0"
                  max="100"
                  formControlName="passives"
                  [class]="enpsSettingsGroup.controls['passives'].invalid && enpsSettingsGroup.controls['passives'].touched
                    ? 'w-full px-2 py-2 border border-[#FF4530] rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-sm text-[#9297A0] text-center'
                    : 'w-full px-2 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-sm text-[#9297A0] text-center'"
                  [attr.aria-invalid]="enpsSettingsGroup.controls['passives'].invalid && enpsSettingsGroup.controls['passives'].touched ? 'true' : 'false'"
                  [attr.aria-describedby]="enpsSettingsGroup.controls['passives'].invalid && enpsSettingsGroup.controls['passives'].touched ? 'passives-error' : null"
                  aria-label="Passives percentage (0-100)"
                  placeholder="0"
                />
                <span class="text-sm text-[#747884]">%</span>
              </div>
              @if (enpsSettingsGroup.controls['passives'].invalid && enpsSettingsGroup.controls['passives'].touched) {
              <div id="passives-error" class="mt-1 text-xs text-red-600" role="alert" aria-live="polite">
                @if (enpsSettingsGroup.controls['passives'].hasError('max')) {
                  Value must be 100 or less
                }
                @if (enpsSettingsGroup.controls['passives'].hasError('min')) {
                  Value must be 0 or greater
                }
              </div>
            }
            </div>
          </div>
          <div class="grid grid-cols-[1fr_20%] bg-[#F1F2F3] gap-2 px-4 py-2">
            <div class="flex justify-start items-center gap-2">
              <p class="bg-[#ff4430] rounded-md px-4 py-1 w-8 h-8"></p>
              <p class="text-[#5B616C] font-medium text-sm uppercase">Detractors</p>
            </div>
            <div class="flex flex-col space-x-1">
              <div class="flex items-center">
                <input
                  type="number"
                  min="0"
                  max="100"
                  formControlName="detractors"
                  [class]="enpsSettingsGroup.controls['detractors'].invalid && enpsSettingsGroup.controls['detractors'].touched
                    ? 'w-full px-2 py-2 border border-[#FF4530] rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-sm text-[#9297A0] text-center'
                    : 'w-full px-2 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-sm text-[#9297A0] text-center'"
                  [attr.aria-invalid]="enpsSettingsGroup.controls['detractors'].invalid && enpsSettingsGroup.controls['detractors'].touched ? 'true' : 'false'"
                  [attr.aria-describedby]="enpsSettingsGroup.controls['detractors'].invalid && enpsSettingsGroup.controls['detractors'].touched ? 'detractors-error' : null"
                  aria-label="Detractors percentage (0-100)"
                  placeholder="0"
                />
                <span class="text-sm text-[#747884]">%</span>
              </div>
              @if (enpsSettingsGroup.controls['detractors'].invalid && enpsSettingsGroup.controls['detractors'].touched) {
              <div id="detractors-error" class="mt-1 text-xs text-red-600" role="alert" aria-live="polite">
                @if (enpsSettingsGroup.controls['detractors'].hasError('max')) {
                  Value must be 100 or less
                }
                @if (enpsSettingsGroup.controls['detractors'].hasError('min')) {
                  Value must be 0 or greater
                }
              </div>
            }
            </div>
          </div>

          <div class="items-center justify-between px-4 py-2 grid grid-cols-[1fr_20%]">
            <span class="text-sm font-medium text-[#5B616C] uppercase">Total</span>
            <span class="text-sm font-medium px-4 py-2 border border-[#E4E5E7] rounded-md bg-white text-[#5B616C] w-full text-center" aria-live="polite" aria-label="eNPS settings total">
              {{ enpsSettingsTotal() }}%
            </span>
          </div>
        </div>
      </fieldset>
    </cdk-step>

    <cdk-step>
      <div class="rounded-lg lg:max-w-5xl w-full mx-auto lg:py-8 py-16" formGroupName="comments">
        <h3 class="text-lg font-medium text-[#282D39]">Comments</h3>
        <p class="text-[#747884] text-xs mt-3">Provide insights or justifications for each selected driver</p>

        <div class="grid grid-cols-1 lg:grid-cols-[30%_1fr] gap-8 mt-8">
          <div>
            <div class="flex items-center justify-between mb-4 bg-[#F1F2F3] px-4 py-3">
              <h4 class="text-[9.9px] font-semibold text-[#747884] uppercase">List of driver</h4>
            </div>

            <div class="space-y-2">
              <button type="button" class="w-full px-4 py-3 hover:bg-[#0082C61A] text-base text-[#363D4D] text-start rounded-sm capitalize" (click)="setCurrentComment(CommentGroup.INNOVATION)" [class.bg-[#0082C61A]]="CommentGroup.INNOVATION === currentCommentSection()">
                {{CommentGroup.INNOVATION}}
              </button>
              <button type="button" class="w-full px-4 py-3 hover:bg-[#0082C61A] text-base text-[#363D4D] text-start rounded-sm capitalize" (click)="setCurrentComment(CommentGroup.MOTIVATION)" [class.bg-[#0082C61A]]="CommentGroup.MOTIVATION === currentCommentSection()">
                {{CommentGroup.MOTIVATION}}
              </button>
              <button type="button" class="w-full px-4 py-3 hover:bg-[#0082C61A] text-base text-[#363D4D] text-start rounded-sm capitalize" (click)="setCurrentComment(CommentGroup.PERFORMANCE)" [class.bg-[#0082C61A]]="CommentGroup.PERFORMANCE === currentCommentSection()">
                {{CommentGroup.PERFORMANCE}}
              </button>
              <button type="button" class="w-full px-4 py-3 hover:bg-[#0082C61A] text-base text-[#363D4D] text-start rounded-sm capitalize" (click)="setCurrentComment(CommentGroup.AUTONOMY)" [class.bg-[#0082C61A]]="CommentGroup.AUTONOMY === currentCommentSection()">
                {{CommentGroup.AUTONOMY}}
              </button>
              <button type="button" class="w-full px-4 py-3 hover:bg-[#0082C61A] text-base text-[#363D4D] text-start rounded-sm capitalize" (click)="setCurrentComment(CommentGroup.CONNECTION)" [class.bg-[#0082C61A]]="CommentGroup.CONNECTION === currentCommentSection()">
                {{CommentGroup.CONNECTION}}
              </button>
            </div>
          </div>

          <div>
            <div class="flex items-center justify-start mb-4 gap-6 bg-[#F1F2F3] px-4 py-3">
              <h4 class="text-[9.9px] font-semibold text-[#747884] uppercase">Comment</h4>
            </div>

            <div class="space-y-2">
              @switch (currentCommentSection()) {
                @case (CommentGroup.INNOVATION) {
                  <div class="flex border border-gray-300 rounded-md shadow-sm bg-white p-2 items-start">
                    <textarea
                    formControlName="innovation"
                    rows="4"
                    [class]="commentsGroup.controls['innovation'].invalid && commentsGroup.controls['innovation'].touched
                      ? 'w-full border border-[#FF4530] focus:outline-none focus:ring-0 rounded-md resize-none'
                      : 'w-full outline-none rounded-md placeholder:text-[#9297A0] text-lg resize-none'"
                    placeholder="Comment on Innovation"></textarea>
                    <img src="images/globe-icon.svg" alt="scenario title globe icon" />
                  </div>
                }
                @case (CommentGroup.MOTIVATION) {
                  <div class="flex border border-gray-300 rounded-md shadow-sm bg-white p-2 items-start">
                    <textarea
                    formControlName="motivation"
                    rows="4"
                    [class]="commentsGroup.controls['motivation'].invalid && commentsGroup.controls['motivation'].touched
                      ? 'w-full border border-[#FF4530] focus:outline-none focus:ring-0 rounded-md resize-none'
                      : 'w-full outline-none rounded-md placeholder:text-[#9297A0] text-lg resize-none'"
                    placeholder="Comment on Motivation"></textarea>
                    <img src="images/globe-icon.svg" alt="scenario title globe icon" />
                  </div>
                }
                @case (CommentGroup.PERFORMANCE) {
                  <div class="flex border border-gray-300 rounded-md shadow-sm bg-white p-2 items-start">
                    <textarea
                    formControlName="performance"
                    rows="4"
                    [class]="commentsGroup.controls['performance'].invalid && commentsGroup.controls['performance'].touched
                      ? 'w-full border border-[#FF4530] focus:outline-none focus:ring-0 rounded-md resize-none'
                      : 'w-full outline-none rounded-md placeholder:text-[#9297A0] text-lg resize-none'"
                    placeholder="Comment on Performance"></textarea>
                    <img src="images/globe-icon.svg" alt="scenario title globe icon" />
                  </div>
                }
                @case (CommentGroup.AUTONOMY) {
                  <div class="flex border border-gray-300 rounded-md shadow-sm bg-white p-2 items-start">
                    <textarea
                    formControlName="autonomy"
                    rows="4"
                    [class]="commentsGroup.controls['autonomy'].invalid && commentsGroup.controls['autonomy'].touched
                      ? 'w-full border border-[#FF4530] focus:outline-none focus:ring-0 rounded-md resize-none'
                      : 'w-full outline-none rounded-md placeholder:text-[#9297A0] text-lg resize-none'"
                    placeholder="Comment on Autonomy"></textarea>
                    <img src="images/globe-icon.svg" alt="scenario title globe icon" />
                  </div>
                }
                @case (CommentGroup.CONNECTION) {
                  <div class="flex border border-gray-300 rounded-md shadow-sm bg-white p-2 items-start">
                    <textarea
                    formControlName="connection"
                    rows="4"
                    [class]="commentsGroup.controls['connection'].invalid && commentsGroup.controls['connection'].touched
                      ? 'w-full border border-[#FF4530] focus:outline-none focus:ring-0 rounded-md resize-none'
                      : 'w-full outline-none rounded-md placeholder:text-[#9297A0] text-lg resize-none'"
                    placeholder="Comment on Connection"></textarea>
                    <img src="images/globe-icon.svg" alt="scenario title globe icon" />
                  </div>
                }
              }
            </div>
          </div>
        </div>
      </div>
    </cdk-step>
  </app-stepper>
</form>